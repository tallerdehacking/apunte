<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><link rel=stylesheet href=/main.e694d66a3c6fa2afcf7e22fe274cbf7b68826715be967e6a094a0037ad19d8af7fd4aea40cbda5561cbd6de1467925a993b85f84e42079c0ff1bf116de1b226c.css integrity="sha512-5pTWajxvoq/PfiL+J0y/e2iCZxW+ln5qCUoAN60Z2K9/1K6kDL2lVhy9beFGeSWpk7hfhOQgecD/G/EW3hsibA==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Buffer Overflow - Taller de Hacking Competitivo</title><meta name=description content="DCC universidad de Chile"><link rel=canonical href=/docs/pwning/buffer-overflow/><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/logo_redondo.png"><meta name=twitter:title content="Buffer Overflow"><meta name=twitter:description content="Buffer Overflow Los ataques de secuestro de control de flujo consisten en aprovechar la entrada de datos de un programa para modificar las instrucciones a ejecutar por este, a partir del aprovechamiento de características propias de la arquitectura del sistema. En este apunte nos enfocaremos en un problema de seguridad denominado Buffer Overflow, el cual sobreescribe parte de la sección de memoria encargada de definir a qué líneas de código ejecutar."><meta name=twitter:site content="@dccuchile"><meta name=twitter:creator content="@dccuchile"><meta property="og:title" content="Buffer Overflow"><meta property="og:description" content="Buffer Overflow Los ataques de secuestro de control de flujo consisten en aprovechar la entrada de datos de un programa para modificar las instrucciones a ejecutar por este, a partir del aprovechamiento de características propias de la arquitectura del sistema. En este apunte nos enfocaremos en un problema de seguridad denominado Buffer Overflow, el cual sobreescribe parte de la sección de memoria encargada de definir a qué líneas de código ejecutar."><meta property="og:type" content="article"><meta property="og:url" content="/docs/pwning/buffer-overflow/"><meta property="og:image" content="/logo_redondo.png"><meta property="article:published_time" content="2020-10-06T08:48:45+00:00"><meta property="article:modified_time" content="2023-06-16T12:44:00-04:00"><meta property="og:site_name" content="Taller de Hacking Competitivo"><meta property="article:publisher" content="https://www.facebook.com/DCCUChile"><meta property="article:author" content="https://www.facebook.com/DCCUChile"><meta property="og:locale" content="es_CL"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"\/"},{"@type":"ListItem","position":2,"name":"Docspwningbuffer Overflow","item":"\/docspwningbuffer-overflow\/"}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest></head><body class="docs single"><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container><input class="menu-btn order-0" type=checkbox id=menu-btn>
<label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 mr-auto" href=/><img class=logo-light src=/images/banner.svg></img>
<img class=logo-dark src=/images/banner_dark.svg></img></a>
<button id=mode class="btn btn-link order-2 order-md-4" type=button aria-label="Toggle mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button><ul class="navbar-nav social-nav order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://github.com/cc5325/apunte><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><span class="ml-2 sr-only">GitHub</span></a></li></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav mr-auto order-5 order-md-2"><li class=nav-item><a class=nav-link href=/blog/>Videos</a></li><li class=nav-item><a class=nav-link href=/docs/prologo/intro>Apunte</a></li><li class=nav-item><a class=nav-link href=/writeups/>Writeups</a></li><li class=nav-item><a class=nav-link href=/tareas/>Evaluaciones</a></li><li class=nav-item><a class=nav-link href=/acerca>Acerca</a></li></ul><div class="break order-6 d-md-none"></div><form class="navbar-form flex-grow-1 order-7 order-md-3"><input id=userinput class="form-control is-search" type=search placeholder="Buscar Documentación..." aria-label="Buscar Documentación..." autocomplete=off><div id=suggestions class="shadow bg-white rounded"></div></form></div></div></header><div class="wrap container" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 docs-sidebar"><nav class=docs-links aria-label="Main navigation"><h3>Prólogo</h3><ul class=list-unstyled><li><a class=docs-link href=/docs/prologo/intro/>Prólogo</a></li></ul><h3>Esteganografía</h3><ul class=list-unstyled><li><a class=docs-link href=/docs/stego/intro/>Intro a la Esteganografía</a></li><li><a class=docs-link href=/docs/stego/conceptos-basicos/>Conceptos Básicos</a></li><li><a class=docs-link href=/docs/stego/cripto-clasica/>Criptografía Clásica</a></li><li><a class=docs-link href=/docs/stego/stego/>Stego en texto, imágenes y audio</a></li><li><a class=docs-link href=/docs/stego/ejercicios/>Ejercicios de Stego</a></li></ul><h3>Criptografía Moderna</h3><ul class=list-unstyled><li><a class=docs-link href=/docs/cripto-moderna/intro/>Intro a Criptografía Moderna</a></li><li><a class=docs-link href=/docs/cripto-moderna/hashing/>Hashing</a></li><li><a class=docs-link href=/docs/cripto-moderna/cripto-simetrica/>Criptografía Simétrica</a></li><li><a class=docs-link href=/docs/cripto-moderna/cripto-asimetrica/>Criptografía Asimétrica</a></li><li><a class=docs-link href=/docs/cripto-moderna/ejercicios/>Ejercicios Cripto Moderna</a></li></ul><h3>Aplicaciones Web</h3><ul class=list-unstyled><li><a class=docs-link href=/docs/apps-web/intro/>Intro a Aplicaciones Web</a></li><li><a class=docs-link href=/docs/apps-web/tecnicas-basicas/>Técnicas Básicas de Análisis Web</a></li><li><a class=docs-link href=/docs/apps-web/xss/>Cross-Site Scripting</a></li><li><a class=docs-link href=/docs/apps-web/inyecciones/>Inyecciones</a></li><li><a class=docs-link href=/docs/apps-web/rce/>Remote Code Execution</a></li><li><a class=docs-link href=/docs/apps-web/reverse-shell/>Reverse Shell</a></li><li><a class=docs-link href=/docs/apps-web/access-control/>Broken Access Control</a></li><li><a class=docs-link href=/docs/apps-web/cve/>Common Vulnerabilities and Exposures</a></li><li><a class=docs-link href=/docs/apps-web/ejercicios/>Ejercicios Apps Web</a></li></ul><h3>Análisis Forense</h3><ul class=list-unstyled><li><a class=docs-link href=/docs/forense/intro/>Introducción al Análisis Forense</a></li><li><a class=docs-link href=/docs/forense/cmd-logs/>Comandos, Logs y Configuraciones</a></li><li><a class=docs-link href=/docs/forense/versionado-recuperacion/>Versionado y Recuperación de Archivos</a></li><li><a class=docs-link href=/docs/forense/wireshark/>Wireshark</a></li><li><a class=docs-link href=/docs/forense/ejercicios/>Ejercicios de Forense</a></li></ul><h3>Ingeniería Reversa</h3><ul class=list-unstyled><li><a class=docs-link href=/docs/reversa/intro/>Intro a la Ingeniería Reversa</a></li><li><a class=docs-link href=/docs/reversa/decompiling/>Decompilación</a></li><li><a class=docs-link href=/docs/reversa/deobfuscation/>Deobfuscación</a></li><li><a class=docs-link href=/docs/reversa/ejercicios/>Ejercicios Reversing</a></li></ul><h3>Pwning</h3><ul class=list-unstyled><li><a class=docs-link href=/docs/pwning/intro/>Intro al Pwning</a></li><li><a class=docs-link href=/docs/pwning/permisos-linux/>Permisos de Usuario en Linux</a></li><li><a class=docs-link href=/docs/pwning/escalamiento-privilegios/>Escalamiento de Privilegios</a></li><li><a class="docs-link active" href=/docs/pwning/buffer-overflow/>Buffer Overflow</a></li><li><a class=docs-link href=/docs/pwning/ejercicios/>Ejercicios de Pwning</a></li></ul><h3>OSINT</h3><ul class=list-unstyled><li><a class=docs-link href=/docs/osint/intro/>Intro a OSINT</a></li><li><a class=docs-link href=/docs/osint/google/>Google Hacking</a></li><li><a class=docs-link href=/docs/osint/github/>Búsqueda en Github</a></li><li><a class=docs-link href=/docs/osint/theharvester/>The Harvester</a></li><li><a class=docs-link href=/docs/osint/haveibeenpwned/>Have I Been Pwned</a></li><li><a class=docs-link href=/docs/osint/shodan/>Shodan</a></li><li><a class=docs-link href=/docs/osint/ejercicios/>Ejercicios OSINT</a></li></ul><h3>Hardware</h3><ul class=list-unstyled><li><a class=docs-link href=/docs/hardware/intro/>Intro a Hardware</a></li><li><a class=docs-link href=/docs/hardware/firmware/>Reversing de Firmware</a></li><li><a class=docs-link href=/docs/hardware/communication/>Protocolos de Comunicación</a></li><li><a class=docs-link href=/docs/hardware/ejercicios/>Ejercicios de Hardware</a></li></ul><h3>Anexos</h3><ul class=list-unstyled><li><a class=docs-link href=/docs/anexos/herramientas/>Herramientas</a></li><li><a class=docs-link href=/docs/anexos/vpn/>Configuración de VPN</a></li><li><a class=docs-link href=/docs/anexos/kali/>Kali Linux</a></li><li><a class=docs-link href=/docs/anexos/proxy/>Proxy</a></li><li><a class=docs-link href=/docs/anexos/comandos/>Comandos de Terminal de Linux</a></li><li><a class=docs-link href=/docs/anexos/referencias/>Referencias</a></li></ul></nav></div><nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation"><div class=page-links><h3>Contenidos</h3><nav id=TableOfContents><ul><li><ul><li><a href=#buffer-overflow>Buffer Overflow</a></li><li><a href=#instrucciones-y-registros-en-asm>Instrucciones y registros en ASM</a></li><li><a href=#punteros>Punteros</a></li><li><a href=#manejo-de-memoria>Manejo de Memoria</a></li><li><a href=#el-programa-en-memoria-y-su-ejecución>El programa en memoria y su ejecución</a></li><li><a href=#la-pila-_stack_>La Pila (<em>Stack</em>)</a></li><li><a href=#shellcode>Shellcode</a></li><li><a href=#el-ataque>El Ataque</a></li><li><a href=#limitaciones>Limitaciones:</a></li><li><a href=#uso-en-ctfs>Uso en CTFs</a></li></ul></li></ul></nav></div></nav><main class="docs-content col-lg-11 col-xl-9 mx-xl-auto"><h1>Buffer Overflow</h1><p class=lead></p><h3 id=buffer-overflow>Buffer Overflow<a href=#buffer-overflow class=anchor aria-hidden=true>#</a></h3><p>Los ataques de secuestro de control de flujo consisten en aprovechar la entrada de datos de un programa para modificar las instrucciones a ejecutar por este, a partir del aprovechamiento de características propias de la arquitectura del sistema. En este apunte nos enfocaremos en un problema de seguridad denominado <strong>Buffer Overflow</strong>, el cual sobreescribe parte de la sección de memoria encargada de definir a qué líneas de código ejecutar.</p><p>Partiremos este capítulo explicando cómo funciona el manejo de memoria en sistemas con arquitectura x86, para luego hablar del ataque en específico. Finalizaremos con un pequeño ejemplo en código de cómo ejecutar un Buffer Overflow en un programa sin mecanismos de defensa.</p><h3 id=instrucciones-y-registros-en-asm>Instrucciones y registros en ASM<a href=#instrucciones-y-registros-en-asm class=anchor aria-hidden=true>#</a></h3><p>Como ya se vio en el capítulo de Reversing, el código que escribimos al programar en un lenguaje compilado es transformado en un código equivalente en funcionalidad pero mucho más simple de interpretar, denominado <em>Assembler</em> (ASM). Este código corre con varias restricciones que no aplican en lenguajes de programación de más alto nivel:</p><ul><li>Las variables utilizables de forma directa se llaman <strong>registros</strong> y son limitadas en número y capacidad. Dependiendo de la arquitectura y del tipo de procesador, un registro puede guardar entre 8 y 256 bits. Los registros más importantes para conocer son:<ul><li><code>eax</code>, <code>ebx</code>, <code>ecx</code>, <code>edx</code>: Registros de 32 bits utilizados de forma general, por ejemplo, para almacenar argumentos de una función. Si se les quita la <code>e</code> que llevan de prefijo, representan registros de 16 bits, y si se les cambia la <code>E</code> por una <code>r</code>.</li><li><code>ebp</code>, <code>esp</code>, <code>edi</code>, <code>esi</code>, <code>eip</code>: Punteros, es decir, apuntan direcciones de memoria RAM en las cuales se encuentran datos a utilizar. La utilidad específica de algunos de ellos se explicará más adelante.</li><li>Operaciones <code>add</code>, <code>sub</code>, <code>mul</code>, <code>div</code>, <code>and</code>, <code>xor</code>: Sirven para operar entre 2 registros o constantes. El valor se guarda en un tercer registro definido en la misma instrucción.</li><li>Operaciones de pila <code>push</code> y <code>pop</code>: permiten sacar y agregar datos de una <strong>pila</strong>, la cual se definirá en la siguiente sección</li><li>Operaciones de control de flujo <code>cmp</code>, <code>je</code>, <code>jne</code>, <code>jg</code>, <code>jl</code>: Permiten condicionar la ejecución de código según un resultado de comparación previo (con <code>cmp</code>). También permiten implementar <strong>loops</strong>.</li><li><code>flags</code> es un <a href=https://en.wikipedia.org/wiki/FLAGS_register>registro especial</a> donde se guarda información sobre el estado del procesador. Algunas de las cosas que se guardan en él son:<ul><li><code>OF</code> o <em>Overflow Flag</em>, muestra si la última operación aritmética hizo overflow (hay reserva)</li><li><code>PF</code> o <em>Parity Flag</em>, indica si el número de bits en valor 1 de la última operación binaria realizada es par o impar.</li><li><code>ZF</code> o <em>Zero Flag</em>, indica que un resultado aritmético previo tenía valor 0.</li><li><code>SF</code> o <em>Sign Flag</em>, indica el signo de la última operación aritmética</li><li><code>CF</code> o <em>Carry Flag</em>, es usada para guardar una reserva en una operación aritmética, de forma de poder hacer operaciones con números más grandes que el tamaño de los registros.</li></ul></li></ul></li></ul><h3 id=punteros>Punteros<a href=#punteros class=anchor aria-hidden=true>#</a></h3><p>A continuación mencionamos la utilidad de algunos punteros importantes:</p><ul><li><code>ebp</code> y <code>esp</code> marcan el inicio y el tope de la pila, respectivamente.</li><li><code>edi</code> y <code>esi</code> se suelen usar para operaciones de copia de Strings</li><li><code>eip</code>: o <em>instruction pointer</em>, apunta a la dirección de memoria en la cual se ubica la instrucción que se está ejecutando en ese momento.</li></ul><h3 id=manejo-de-memoria>Manejo de Memoria<a href=#manejo-de-memoria class=anchor aria-hidden=true>#</a></h3><p><img src=../2021-06-17-00-17-38.png alt="Manejo de Memoria"></p><p>La imagen superior muestra cómo se ordena la memoria en un sistema x86. La imagen muestra las direcciones de memoria partiendo abajo y creciendo hacia arriba. Estas tienen un tamaño de 32 bits (4 bytes) y se acceden de 4 en 4 bytes.</p><p>Existen 6 bloques importantes en la memoria completa:</p><ul><li><strong>Stack (Pila)</strong> Acá se almacenan las variables locales de los programas. Veremos más adelante que cada vez que se llama a una nueva función, se agrega un <em>frame</em> al stack. Un <em>frame</em> equivale al ambiente local inmediato de variables locales de una función. Como se ve en la imagen, <strong>El Stack crece hacia abajo</strong> (direcciones de memoria decrecientes).</li><li><strong>Espacio Libre</strong>: Entre el <em>stack</em> y el <em>heap</em> hay memoria libre. El crecimiento de ambos disminuye la cantidad de memoria libre disponible.</li><li><strong>Heap</strong>: Espacio que maneja la memoria dinámica, es decir, en el caso de C, las variables declaradas con <code>malloc</code>, además de algunas funciones.</li><li><strong>BSS</strong>: Memoria variable reservada antes de ejecutar el <em>main</em> de un programa en C.</li><li><strong>Data</strong>: Constantes.</li><li><strong>Text</strong>: Instrucciones en ASM a ejecutar.</li></ul><h3 id=el-programa-en-memoria-y-su-ejecución>El programa en memoria y su ejecución<a href=#el-programa-en-memoria-y-su-ejecución class=anchor aria-hidden=true>#</a></h3><p>En el bloque <code>Data</code> se ubica una copia de las instrucciones que componen el programa que se está ejecutando. Debido a lo anterior, este bloque suele ser <em>de solo lectura</em>. Para saber en qué instrucción se está en cada momento del programa, se almacena en <code>eip</code> el valor de la instrucción actual, el cual es incrementado en una posición cada vez que se finaliza de ejecutar una instrucción, excepto en casos en los que se ejecuta una instrucción <code>jmp</code></p><p>Las instrucciones <code>cmp</code> y <code>test</code> actualiza</p><p>Las instrucciones <code>jmp</code> ejecutan un salto incondicional hacia una nueva dirección de memoria indicada en la misma instrucción. También existen <em>jump condicionales</em>, los cuales se ejecutan según el estado de flags del registro <code>flags</code>. <a href=http://unixwiz.net/techtips/x86-jumps.html>Acá</a> se pueden ver los tipos de saltos.</p><h3 id=la-pila-_stack_>La Pila (<em>Stack</em>)<a href=#la-pila-_stack_ class=anchor aria-hidden=true>#</a></h3><p>Como se mencionó anteriormente, la pila es el lugar en el que se guardan las variables locales de las funciones. Cada vez que entramos a una función, creamos un nuevo <em>frame</em>, el cual se inicializa como una pila vacía, en el cual colocamos las nuevas variables locales a crearse. Al momento de salir del frame, este se descarta, activándose nuevamente el frame inmediatamente anterior.</p><p>Al entrar a un nuevo frame, se guarda la dirección de memoria actual dentro de la función (<code>EIP</code>) en la misma pila, y luego este valor se llena con el de la función anidada. De esta forma, al salir de la función anidada, se sabrá como volver a la función anterior.</p><p>¿Cómo sabemos donde parte y donde termina la pila? Usamos los punteros <code>esp</code> y <code>ebp</code> para guardar estos datos. <code>ebp</code> registra la dirección de memoria en la cual parte el frame actual, mientras <code>esp</code> guarda la dirección de memoria siguiente a la última utilizada. Cuando se crea un frame nuevo, ambos valores se guardan en la pila y se setean al valor siguiente al último de la pila, emulando de este modo una pila vacía, ya que base y tope son la misma posición.</p><p>El siguiente conjunto de imágenes muestra cómo se opera en la pila y cómo se crean frames.</p><p><img src=../2021-06-18-14-05-47.png alt></p><p><img src=../2021-06-18-14-06-41.png alt></p><p><img src=../2021-06-18-14-07-38.png alt></p><p>Para eliminar un frame, se siguen los pasos inversos de la segunda imagen, es decir, se cargan los valores de más arriba de la pila como <code>esp</code>, <code>ebp</code> y <code>eip</code>.</p><h3 id=shellcode>Shellcode<a href=#shellcode class=anchor aria-hidden=true>#</a></h3><p><img src=../2021-06-18-11-56-26.png alt></p><p>¿Cómo se guarda el código que ejecutamos en <code>Data</code>? Al igual que cualquier dato del computador: usando <code>0s</code> y <code>1s</code>. Esto quiere decir que una variable con la forma y valor adecuado podría perfectamente ser interpretada como un programa si logramos que <code>EIP</code> apunte a la zona de memoria en que se encuentra guardada.</p><p>La representación en texto de un código ejecutable es conocida como <code>shellcode</code> cuando ésta permite levantar una <code>shell</code> luego de ser ejecutada.</p><p>Es posible encontrar un listado de shellcodes clasificados por OS y arquitectura de procesador en <a href=https://www.exploit-db.com/shellcodes>este enlace</a> o <a href=http://shell-storm.org/shellcode/>acá</a>. También es posible crear shellcodes propios usando herramientas especiales o incluso a mano, como muestra <a href=https://www.exploit-db.com/docs/english/13610-building-your-own-ud-shellcodes-part-1.pdf>este tutorial</a>.</p><h3 id=el-ataque>El Ataque<a href=#el-ataque class=anchor aria-hidden=true>#</a></h3><p>Un ataque de Buffer Overflow se aprovecha de las nulas protecciones que algunos lenguajes de bajo nivel poseen sobre el acceso a memoria. Para ejemplificarlo, contaremos con el siguiente programa:</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span><span class=cp></span><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;usage: %s name&#34;</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
        <span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=kt>char</span> <span class=n>password</span> <span class=o>=</span> <span class=sc>&#39;a&#39;</span><span class=p>;</span>
    <span class=kt>char</span>  <span class=n>nombre</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>
    <span class=n>strcpy</span><span class=p>(</span><span class=n>nombre</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;hola %s. Veremos si tienes acceso...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>nombre</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>password</span> <span class=o>==</span> <span class=sc>&#39;#&#39;</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Acceso otorgado! (password=%c)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>password</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Acceso denegado (password=%c)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>password</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>Las variables <code>password</code> y <code>nombre</code> se almacenan en la pila de forma consecutiva. El espacio morado corresponde a cada byte en la pila de la variable <code>nombre</code>, y el espacio verde al único <code>char</code> de la variable <code>password</code>. Si guardamos &ldquo;Ana&rdquo; en <code>nombre</code>, el stack quedaría así:</p><p><img src=../2021-06-18-15-15-29.png alt></p><p>El <code>\0</code> final corresponde al byte nulo, usado para marcar el fin de una cadena de texto.</p><p>En cambio, si entregásemos el valor <code>Dani#</code> como <code>nombre</code>, el char de <code>password</code> se vería sobreescrito por el <code>#</code>, lo que nos dejaría entrar a la branch <em>Acceso otorgado!</em>.</p><p><img src=../2021-06-18-22-13-56.png alt></p><p>Esta misma estrategia de overflow en variables se puede usar para sobreescribir más allá de las variables locales:</p><p>Supongamos que estamos en una función con una variable local <code>nombre</code>. Más allá de esta variable encontraremos en la pila dos valores: <code>ret</code> (Dirección de retorno del <code>EIP</code> al finalizar la función) y <code>EBP</code> (puntero a la base de la pila del frame inferior). Si agrandamos <code>nombre</code> lo suficiente, podremos sobreescribir <code>ret</code> con un valor a nuestra elección, el cual podría apuntar a una dirección de memoria en la que sabemos que hay código útil.</p><p><img src=../2021-06-18-22-34-46.png alt></p><p>La mejor referencia para entender paso a paso un Buffer Overflow la pueden encontrar en el artículo <a href=./smash-stacking.pdf>Smashing the Stack for Fun and Profit</a> del colectivo Hacker <em>Aleph One</em>.
)</p><h3 id=limitaciones>Limitaciones:<a href=#limitaciones class=anchor aria-hidden=true>#</a></h3><p>Si bien lo anterior fue un problema sumamente grabe hace varios años, hoy en día existen una serie de mitigaciones en distintos niveles para evitar este tipo de comportamientos anómalos, acá mencionamos algunas:</p><ul><li><strong>A nivel de sist. Operativo</strong>: Mitigaciones que dependen del sist. operativo usado para ejecutar el programa. Hoy en día todas se encuentran activas por defecto, salvo para la ejecución de programas antiguos que no las soportan.</li><li><strong>Write XOR Execute</strong>: Característica que limita el uso de la memoria de un proeso para que ésta sea escribible O ejecutable, pero no ambas a la vez.</li><li><strong>ASLR</strong>: Direcciones de memoria de una aplicación se aleatorizan en cada ejecución, con lo que se dificulta la posibilidad de saltar a un espacio específico.</li><li><strong>DEP</strong>: Marcar algunas páginas de memoria como explícitamente no ejecutables.</li><li><strong>A nivel de compilación</strong>: Estas mitigaciones son flags del compilador que dificultan la explotación de buffer overflows.</li><li><strong>Stack Canaries</strong>: Valores aleatorios en la pila que se colocan al entrar a un frame y luego se revisan al salir de él, de esta forma, se dificulta la modificación del stack a través de overflows, ya que es necesario adivinar el valor original del canario colocado.</li></ul><h3 id=uso-en-ctfs>Uso en CTFs<a href=#uso-en-ctfs class=anchor aria-hidden=true>#</a></h3><p>Por temas de tiempo y de alcance, no contaremos en esta iteración del curso con material especial para preparar payloads en CTFs. Sin embargo, veremos en la clase en vivo el siguiente tutorial elaborado por <a href=https://padraignix.github.io/reverse-engineering/2019/09/28/buffer-overflow-practical-case-study>padragnix</a>. El link incluye harto material relacionado e incluso una presentación de PowerPoint para revisar.</p><p class=edit-page><a href=https://github.com/cc5325/apunte/blob/main/content/docs/pwning/buffer-overflow.md><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828.0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>Editar en GitHub</a>
<span class=date-info><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>Modificado por última vez el 16/06/2023 a las 12:44:00 hrs.</span></p><div class="docs-navigation d-flex justify-content-between"><a href=/docs/pwning/escalamiento-privilegios/><div class="card my-1"><div class="card-body py-2">&larr; Escalamiento de Privilegios</div></div></a><a class=ml-auto href=/docs/pwning/ejercicios/><div class="card my-1"><div class="card-body py-2">Ejercicios de Pwning &rarr;</div></div></a></div></main></div></div></div><footer class="footer text-muted"><div class=container><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Sitio generado con <a href=https://gohugo.io/>Hugo</a> y <a href=https://getdoks.org/>Doks</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-right"><ul class=list-inline><a href="http://creativecommons.org/licenses/by-sa/4.0/?ref=chooser-v1" target=_blank rel="license noopener noreferrer" style=display:inline-block>CC BY-SA 4.0<img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1"><img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1"><img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1"></a></ul></div></div></div></footer><script src=/main.2507c05f91ee016250e43b67b3d342f5a0d9d4dc5264f76cdc4518cd36a9e04cf3022ce8362802e618d8130b6733b53ee845a49e67229eeb3d3e70347db96a2b.js integrity="sha512-JQfAX5HuAWJQ5Dtns9NC9aDZ1NxSZPds3EUYzTap4EzzAizoNigC5hjYEwtnM7U+6EWknmcinus9PnA0fblqKw==" crossorigin=anonymous defer></script><script src=/index.min.3b1f210c1dcacbb50243e4eff1a3e28b20636cd64af981ccaff4ff25daf50cc6f51898e89ce578389c967207038a3eba8ecc078bee1c32f940332d2c00dc7aa5.js integrity="sha512-Ox8hDB3Ky7UCQ+Tv8aPiiyBjbNZK+YHMr/T/Jdr1DMb1GJjonOV4OJyWcgcDij66jswHi+4cMvlAMy0sANx6pQ==" crossorigin=anonymous defer></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['\\[','\\]']],processEscapes:true,processEnvironments:true},options:{skipHtmlTags:['script','noscript','style','textarea','pre']}};window.addEventListener('load',(event)=>{document.querySelectorAll("mjx-container").forEach(function(x){x.parentElement.classList+='has-jax'})});</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></body></html>